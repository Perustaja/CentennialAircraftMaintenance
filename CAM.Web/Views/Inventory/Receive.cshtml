@model CAM.Web.ViewModels.Inventory.InventoryReceiveViewModel
@{
    ViewData["Title"] = "Receive a shipment";
}

@await Html.PartialAsync("_StatusMessagePartial", TempData)
<div class="centered-form-container">
    <div class="form-panel shadowed" style="min-width: 1000px;">
        <div class="title-panel">
            <h3>Receive a shipment</h3>
            <hr />
        </div>
        @* Doesn't use inline form or align-items-center with col-auto because of autocomplete elements *@
        <form asp-controller="Inventory" asp-action="AddToReceivingList" data-ajax="true" data-ajax-method="post" data-ajax-success="verifyThenAppend" data-ajax-failure="onAddFail">
            <div class="form-row justify-content-center pt-3">
                <div class="form-group autocomplete col-md-6">
                    @* <span class="text-muted ml-1" style="font-size: 13px;">Click here to add a non-existing part.</span> *@
                    <span class="fa fa-search form-search-input"></span>
                    <input asp-for="InputPartNumber" id="searchParts" type="text" class="form-control has-search-icon" placeholder="Search for a part..." autocomplete="off" />
                    <span asp-validation-for="InputPartNumber" class="text-danger" style="position: absolute; z-index: -1;"></span>
                </div>
                <div class="form-group col-md-2">
                    <input asp-for="InputQuantity" id="partQty" class="form-control" value="1" placeholder="Qty" />
                    <span asp-validation-for="InputQuantity" class="text-danger"></span>
                </div>
                <div class="form-group col-md-2">
                    <button type="submit" id="addPart" class="btn btn btn-secondary"><i class="far fa-plus-square"></i> Add to list</button>
                </div>
            </div>
        </form>
        <hr />
        <div class="row receive-header">
            <div class="col-md-12">
                <span>Current queue of parts</span>
            </div>
        </div>
        <form asp-controller="Inventory" asp-action="Receive" data-ajax="true" data-ajax-method="post" 
            data-ajax-confirm="Are you sure you want to submit this list?" data-ajax-failure="onListSubmitFail">
            <div class="row" id="partsList">

            </div> 
            <div class="form-group">
                <button type="submit">Submit</button>
            </div>
        </form>
    </div>
</div>

@* Ajax failure modal with root div id of ajaxFailModal*@
@await Html.PartialAsync("_ModalNotificationPartial", "ajaxFailModal");

@section Scripts {
    @* Parts search API and ajax *@
    <script>
        partsAutoComplete("searchParts");

        // Ajax

        // Works with ReceiveListPartial classes
        verifyThenAppend = function (data, status, xhr) {
            var dataHtml = $($(data).html());
            dataHtml.
            var newPartId = dataHtml.getElementById("newPartId");
            var newQty = dataHtml.getElementById("newPartQty");
            var existingIds = document.getElementsByClassName("part-id");
            for (var i = 0; i < existingIds.length; i++) {
                if (newPartId.innerText == existingIds[i].innerText) {
                    var existingQtys = document.getElementsByClassName("part-qty");
                    existingQtys[i].val(existingQtys[i].val() + newQty.val()).trigger("change");
                    return;
                }                
            }
            // no match found. Clear ids before appending
            newPartId.removeAttribute("id");
            newQty.removeAttribute("id");
            $("#partsList").append($.parseHTML(dataHtml));
        };

        onAddFail = function (xhr) {
            showModal("ajaxFailModal", "Unable to add part", 
            "The server was unable to add the specified part, please ensure the part exists.<br /> <br /> If the issue persists, contact site administration.")
        };

        onListSubmitFail = function (xhr) {
            alert(`${xhr.status}: ${xhr.statusText}`);
        };
    </script>
}